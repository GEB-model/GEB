# Routing

## Introduction

The routing module in GEB is responsible for moving water through the river network. It takes runoff generated by the land surface (sideflow) and routes it downstream towards the ocean or inland sinks (pits). The routing module also handles the interaction between river flow and waterbodies (lakes and reservoirs).

The river network topology is derived from a Local Drain Direction (LDD) map using the [pyflwdir](https://deltares.github.io/pyflwdir/) package.

The LDD is a 2D array where each cell contains a value representing the direction of flow to its downstream neighbor. The coding scheme corresponds to the layout of a numeric keypad (look at your keyboard if you have one!):

<table style="border: 1px solid black; border-collapse: collapse; text-align: center; margin: auto;">
  <tbody>
    <tr>
      <td style="border: 1px solid black; padding: 10px;">7 (NW)</td>
      <td style="border: 1px solid black; padding: 10px;">8 (N)</td>
      <td style="border: 1px solid black; padding: 10px;">9 (NE)</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 10px;">4 (W)</td>
      <td style="border: 1px solid black; padding: 10px;">5 (Pit)</td>
      <td style="border: 1px solid black; padding: 10px;">6 (E)</td>
    </tr>
    <tr>
      <td style="border: 1px solid black; padding: 10px;">1 (SW)</td>
      <td style="border: 1px solid black; padding: 10px;">2 (S)</td>
      <td style="border: 1px solid black; padding: 10px;">3 (SE)</td>
    </tr>
  </tbody>
</table>

*   **1-4, 6-9**: Direction of flow to one of the 8 neighbors.
*   **5**: Represents a pit or sink (locally lowest point), where flow ends or leaves the domain (e.g., the ocean).
*   **255**: Undefined/No data.

## General Framework

All routing algorithms in GEB inherit from a common `Router` base class. This class handles the initialization of the river network topology, including:

*   Determining the upstream connections for every cell using the LDD.
*   Sorting cells from upstream to downstream to allow for efficient iterative solving.
*   Identifying waterbody locations and their outflow points.

In each timestep, the routing module takes the following inputs:

*   **Previous Discharge**: The water flowing in the river from the previous step.
*   **Sideflow**: New water entering the river channel from the land surface (runoff + return flow from irrigation).
*   **Evaporation**: Water loss from the river surface.
*   **Waterbody Outflows**: Water released from reservoirs or lakes.

The router then calculates:

*   **New Discharge**: The flow rate in each river cell for the current step.
*   **Waterbody Inflow**: The volume of water entering lakes/reservoirs.
*   **River Storage**: The volume of water stored in the channel.

## Routing substeps

The routing module uses hourly substeps. Each day, the `step` [method](../model/modules.md) receives 24 hours of runoff data (`total_runoff_m`), provided as a 2D array with shape (24, number of grid cells), where each row represents the total runoff depth (in meters) generated by the land surface for that hour. Then 24 substeps are executed, with each substep doing the following:

1. **Sideflow Calculation**: The hourly runoff depth is converted to volume (mÂ³) by multiplying by the cell area.

2. **Evaporation Calculation**: Hourly evaporation from the river surface is calculated using precalculated reference evapotranspiration data, scaled by the cell area and the channel ratio (fraction of cell area occupied by the river channel).

3. **Routing Execution**: The routing algorithm (Kinematic Wave or Accuflux) is executed with this hourly sideflow, along with other inputs like evaporation and waterbody outflows. This updates the river discharge and storage for that hour.

## Interaction with Water Bodies

The routing module integrates tightly with lakes and reservoirs (collectively "water bodies"). Water bodies are represented as specific areas on the grid, covering one or more cells. This interaction occurs in every hourly substep.

1.  **Interception of Flow**: Any river flow or surface runoff entering a cell designated as a water body is intercepted. Instead of continuing downstream via the river routing equations, this water is added directly to the water body storage. This effectively breaks the continuous river routing at the inlet of a lake or reservoir.
2.  **Storage Update**: The total inflow (accumulated from all cells belonging to the water body) is passed to the water body module, which manages the storage volume. Note that evaporation from the water surface is handled by the water body module, not the routing module.
3.  **Release**: Water leaves the water body based on specific rules (e.g., reservoir operating rules or a lake rating curve). This water body outflow is re-injected into the river network at a designated outflow cell for the water body. This outflow becomes the upstream boundary condition for the river segment immediately downstream of the water body.

## Optional inflow

Optionally inflow from outside the model area can be added to the model. This is simulated as additional sideflow into the channels. Currently no inflow can be added to waterbodies, but this may be supported in the future. Let us know if you are interested.

## Routing Algorithms

GEB currently supports two routing algorithms. Kinematic wave is the best one for most purposes. The accuflux algorithm is mostly used for debugging purposes because it is easy to close the water balance.

### Kinematic Wave

The `Kinematic Wave` router approximates the full Saint-Venant equations [@chow1988applied] by assuming that the friction slope equals the bed slope. This simplification implies that there is no backwater effect and that flow is always moving downstream.

The method couples the continuity equation (conservation of mass):

$$ \frac{\partial Q}{\partial x} + \frac{\partial A}{\partial t} = q_{lat} $$

with a simplified momentum equation expressed as a power law relationship between channel cross-sectional area ($A$) and discharge ($Q$):

$$ A = \alpha Q^{\beta} $$

Where:

*   $Q$ is discharge [$m^3/s$].
*   $A$ is wetted cross-sectional area [$m^2$].
*   $q_{lat}$ is lateral inflow per unit length [$m^2/s$].
*   $t$ is time [$s$] and $x$ is distance along the river [$m$].
*   $\alpha$ and $\beta$ are parameters related to channel geometry and roughness. For a wide rectangular channel using Manning's equation, $\beta = 0.6$ and $\alpha = (n \cdot P^{2/3} / \sqrt{S})^{0.6}$, where $n$ is Manning's roughness, $P$ is wetted perimeter, and $S$ is the slope.

Substituting the momentum equation into the continuity equation yields a non-linear Partial Differential Equation (PDE) for $Q$. GEB discretizes this equation using a fully implicit finite difference scheme over a generic cell of length $\Delta x$:

$$ \frac{Q_{new} - Q_{in}}{\Delta x} + \frac{\alpha Q_{new}^{\beta} - \alpha Q_{old}^{\beta}}{\Delta t} = q_{lat} $$

Rearranging to solve for the unknown discharge $Q_{new}$:

$$ \frac{\Delta t}{\Delta x} Q_{new} + \alpha Q_{new}^{\beta} = \frac{\Delta t}{\Delta x} Q_{in} + \alpha Q_{old}^{\beta} + \Delta t \cdot q_{lat} $$

Where:

*   $Q_{new}$: Discharge leaving the cell at the current timestep.
*   $Q_{old}$: Discharge leaving the cell at the previous timestep.
*   $Q_{in}$: Total discharge entering the cell from upstream at the current timestep.

Since this equation is non-linear in $Q_{new}$, it is solved iteratively using the Newton-Raphson method for every cell in the network, proceeding from upstream to downstream. This implicit scheme ensures numerical stability even for large timesteps, although accuracy improves with smaller timesteps.

### Accuflux (Simple Accumulation)

The `Accuflux` router is a simple accumulation scheme. It assumes that all water entering a river cell (from upstream or sideflow) flows out of that cell within the same timestep. This algorithm is mostly used for debugging and testing purposes because it is very easy to close the water balance.

For every cell (processed from upstream to downstream):

$$ Q_{out} = \sum Q_{in} + Q_{sideflow} - E_{evaporation} $$

## Code

::: geb.hydrology.routing
